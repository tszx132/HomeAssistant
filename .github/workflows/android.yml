name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      run: |
        echo "设置 Android SDK..."
        
        # 下载命令行工具
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        
        # 创建正确的目录结构
        mkdir -p android-sdk/cmdline-tools
        unzip -q cmdline-tools.zip -d android-sdk/cmdline-tools/
        
        # 重命名目录到 latest
        mv android-sdk/cmdline-tools/cmdline-tools android-sdk/cmdline-tools/latest
        
        # 验证文件结构
        echo "Android SDK 目录结构:"
        find android-sdk -type f -name "sdkmanager" | head -10
        echo "sdkmanager 完整路径:"
        find android-sdk -name "sdkmanager" -type f
        
        # 设置环境变量
        echo "ANDROID_HOME=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        # 清理
        rm -f cmdline-tools.zip
        
    - name: Setup Android PATH and verify
      run: |
        echo "设置 PATH 并验证..."
        
        # 将 Android 工具添加到 PATH
        echo "$GITHUB_WORKSPACE/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        
        # 查找 sdkmanager 的确切位置
        SDKMANAGER_PATH=$(find $GITHUB_WORKSPACE/android-sdk -name "sdkmanager" -type f | head -1)
        echo "找到 sdkmanager: $SDKMANAGER_PATH"
        
        if [ -f "$SDKMANAGER_PATH" ]; then
          echo "sdkmanager 文件存在，设置执行权限..."
          chmod +x "$SDKMANAGER_PATH"
          echo "测试运行:"
          $SDKMANAGER_PATH --version || echo "版本检查失败"
        else
          echo "错误: 未找到 sdkmanager 文件"
          echo "当前目录结构:"
          find android-sdk -type d | sort
          exit 1
        fi
        
    - name: Accept Android licenses
      run: |
        echo "接受 Android 许可证..."
        
        # 查找 sdkmanager
        SDKMANAGER_PATH=$(find $GITHUB_WORKSPACE/android-sdk -name "sdkmanager" -type f | head -1)
        echo "使用 sdkmanager: $SDKMANAGER_PATH"
        
        # 接受许可证
        yes | $SDKMANAGER_PATH --licenses || echo "许可证可能已接受"
        
    - name: Install Android components
      run: |
        echo "安装 Android 组件..."
        
        SDKMANAGER_PATH=$(find $GITHUB_WORKSPACE/android-sdk -name "sdkmanager" -type f | head -1)
        
        # 安装平台工具
        $SDKMANAGER_PATH "platform-tools"
        echo "✅ platform-tools 安装完成"
        
        # 安装 Android 平台
        $SDKMANAGER_PATH "platforms;android-33"
        echo "✅ Android 33 平台安装完成"
        
        # 安装构建工具
        $SDKMANAGER_PATH "build-tools;33.0.0"
        echo "✅ 构建工具安装完成"
        
        # 将 platform-tools 添加到 PATH
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Cordova
      run: |
        npm install -g cordova@latest
        
    - name: Add Android platform
      run: |
        cordova platform add android@12.0.0
        
    - name: Build Android APK
      run: |
        cordova build android --release
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk