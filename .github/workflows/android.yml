name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Java 17
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        
    - name: Setup Android SDK
      run: |
        # ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ SDKï¼Œç»Ÿä¸€ç¯å¢ƒå˜é‡
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        
        # æ¥å—è®¸å¯è¯
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # å®‰è£…å¿…è¦çš„ç»„ä»¶
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2"
        echo "âœ… Android SDK ç»„ä»¶å®‰è£…å®Œæˆ"
        
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and platform
      run: |
        npm install -g cordova@latest
        
        # æ¸…ç†
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°
        cordova platform add android@latest
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        cordova build android --release --verbose
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk