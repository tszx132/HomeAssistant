name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Java 17 for Android SDK
      run: |
        # å®‰è£… Java 17ï¼ˆAndroid SDK éœ€è¦ï¼‰
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
        
        # è®¾ç½® JAVA_HOME
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        
    - name: Setup Android SDK with Java 17
      run: |
        # ä¸‹è½½ Android SDK
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        
        # è§£å‹
        unzip -q commandlinetools-linux-11076708_latest.zip -d android-sdk/
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        SDKMANAGER=$(find android-sdk -name "sdkmanager" -type f | head -1)
        echo "SDKMANAGER=$SDKMANAGER" >> $GITHUB_ENV
        SDK_DIR=$(dirname "$SDKMANAGER")
        echo "$SDK_DIR" >> $GITHUB_PATH
        
        # å®‰è£… Android ç»„ä»¶ï¼ˆä½¿ç”¨ Java 17ï¼‰
        yes | "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - name: Switch to Java 11 for Cordova build
      run: |
        # å®‰è£… Java 11ï¼ˆCordova æ„å»ºéœ€è¦ï¼‰
        sudo apt-get install -y openjdk-11-jdk
        
        # åˆ‡æ¢åˆ° Java 11
        echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
        sudo update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java
        sudo update-alternatives --set javac /usr/lib/jvm/java-11-openjdk-amd64/bin/javac
        
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and platform
      run: |
        # ä½¿ç”¨ Cordova 11
        npm install -g cordova@11.0.0
        
        # æ¸…ç†
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°
        cordova platform add android@12.0.0
        
    - name: Install compatible Gradle for Java 11
      run: |
        echo "ğŸ“¦ å®‰è£…ä¸ Java 11 å…¼å®¹çš„ Gradle..."
        
        # ç§»é™¤ç³»ç»Ÿ Gradle
        sudo rm -f /usr/bin/gradle
        sudo rm -rf /usr/share/gradle*
        
        # ä¸‹è½½ Gradle 7.5ï¼ˆä¸ Java 11 å…¼å®¹ï¼‰
        wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
        unzip -q gradle-7.5-bin.zip
        sudo mv gradle-7.5 /opt/gradle
        sudo ln -s /opt/gradle/bin/gradle /usr/bin/gradle
        
        echo "âœ… å®‰è£… Gradle 7.5 å®Œæˆ"
        gradle --version
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        cordova build android --release
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk