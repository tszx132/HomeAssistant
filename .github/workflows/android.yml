name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Java
      run: sudo apt-get update && sudo apt-get install -y openjdk-8-jdk
        
    - name: Setup Android SDK
      run: |
        # ä½¿ç”¨è¾ƒæ–°çš„ Android SDK ç‰ˆæœ¬
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        
        unzip -q commandlinetools-linux-11076708_latest.zip -d android-sdk/
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        SDKMANAGER=$(find android-sdk -name "sdkmanager" -type f | head -1)
        echo "SDKMANAGER=$SDKMANAGER" >> $GITHUB_ENV
        SDK_DIR=$(dirname "$SDKMANAGER")
        echo "$SDK_DIR" >> $GITHUB_PATH
        
        # å®‰è£… Android ç»„ä»¶
        yes | "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools" "platforms;android-30" "build-tools;30.0.3"
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - uses: actions/setup-node@v4
      with:
        node-version: '16'
        
    - name: Install Cordova and available platform
      run: |
        # ä½¿ç”¨ Cordova 11ï¼ˆæœ€æ–°ç¨³å®šç‰ˆï¼‰
        npm install -g cordova@11.0.0
        
        # æ¸…ç†
        rm -rf platforms/android plugins
        
        # æ·»åŠ å¯ç”¨çš„ Android å¹³å°ç‰ˆæœ¬
        echo "å°è¯•æ·»åŠ  Android å¹³å°..."
        cordova platform add android@10.1.1 || \
        cordova platform add android@9.1.0 || \
        cordova platform add android@9.0.0 || \
        cordova platform add android
        
    - name: Remove system Gradle and force compatible version
      run: |
        echo "ğŸ—‘ï¸ ç§»é™¤ç³»ç»Ÿ Gradle..."
        # ç§»é™¤ç³»ç»Ÿå®‰è£…çš„ Gradle
        sudo rm -f /usr/bin/gradle
        sudo rm -rf /usr/share/gradle*
        
        # æ ¹æ® Android å¹³å°ç‰ˆæœ¬å®‰è£…å…¼å®¹çš„ Gradle
        if cordova platform | grep -q "android@10"; then
          echo "ğŸ“¦ å®‰è£… Gradle 7.5ï¼ˆAndroid 10 å…¼å®¹ï¼‰"
          wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
          unzip -q gradle-7.5-bin.zip
          sudo mv gradle-7.5 /opt/gradle
          sudo ln -s /opt/gradle/bin/gradle /usr/bin/gradle
        elif cordova platform | grep -q "android@9"; then
          echo "ğŸ“¦ å®‰è£… Gradle 6.9ï¼ˆAndroid 9 å…¼å®¹ï¼‰"
          wget -q https://services.gradle.org/distributions/gradle-6.9-bin.zip
          unzip -q gradle-6.9-bin.zip
          sudo mv gradle-6.9 /opt/gradle
          sudo ln -s /opt/gradle/bin/gradle /usr/bin/gradle
        else
          echo "ğŸ“¦ å®‰è£… Gradle 6.5ï¼ˆé»˜è®¤å…¼å®¹ï¼‰"
          wget -q https://services.gradle.org/distributions/gradle-6.5-bin.zip
          unzip -q gradle-6.5-bin.zip
          sudo mv gradle-6.5 /opt/gradle
          sudo ln -s /opt/gradle/bin/gradle /usr/bin/gradle
        fi
        
        echo "âœ… Gradle å®‰è£…å®Œæˆ"
        gradle --version
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        cordova build android --release
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk