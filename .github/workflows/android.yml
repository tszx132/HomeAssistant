name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Java
      run: sudo apt-get update && sudo apt-get install -y openjdk-8-jdk
        
    - name: Setup Android SDK
      run: |
        # ä½¿ç”¨è¾ƒæ—§çš„ Android SDK ç‰ˆæœ¬
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8092744_latest.zip
        
        unzip -q commandlinetools-linux-8092744_latest.zip -d android-sdk/
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        SDKMANAGER=$(find android-sdk -name "sdkmanager" -type f | head -1)
        echo "SDKMANAGER=$SDKMANAGER" >> $GITHUB_ENV
        SDK_DIR=$(dirname "$SDKMANAGER")
        echo "$SDK_DIR" >> $GITHUB_PATH
        
        # å®‰è£…è¾ƒæ—§çš„ Android ç»„ä»¶
        yes | "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools" "platforms;android-28" "build-tools;28.0.3"
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - uses: actions/setup-node@v4
      with:
        node-version: '14'
        
    - name: Install Cordova and platform
      run: |
        # ä½¿ç”¨ Cordova 8 å’Œ Android 7ï¼ˆæœ€ç¨³å®šï¼‰
        npm install -g cordova@8.1.0
        
        # æ¸…ç†
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°
        cordova platform add android@7.1.4
        
    - name: Remove system Gradle and force compatible version
      run: |
        echo "ğŸ—‘ï¸ ç§»é™¤ç³»ç»Ÿ Gradle..."
        # ç§»é™¤ç³»ç»Ÿå®‰è£…çš„ Gradle
        sudo rm -f /usr/bin/gradle
        sudo rm -rf /usr/share/gradle*
        
        # ä¸‹è½½å¹¶å®‰è£…å…¼å®¹çš„ Gradle
        wget -q https://services.gradle.org/distributions/gradle-6.5-bin.zip
        unzip -q gradle-6.5-bin.zip
        sudo mv gradle-6.5 /opt/gradle
        sudo ln -s /opt/gradle/bin/gradle /usr/bin/gradle
        
        echo "âœ… å®‰è£… Gradle 6.5 å®Œæˆ"
        gradle --version
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        cordova build android --release
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk