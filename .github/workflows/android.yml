name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install correct Java version
      run: |
        # å®‰è£… Java 11ï¼ˆGradle 6.5 å…¼å®¹çš„ç‰ˆæœ¬ï¼‰
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk
        
        # è®¾ç½® JAVA_HOME
        echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
        
    - name: Setup Android SDK
      run: |
        # ä¸‹è½½ Android SDK
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        
        # è§£å‹
        unzip -q commandlinetools-linux-11076708_latest.zip -d android-sdk/
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        SDKMANAGER=$(find android-sdk -name "sdkmanager" -type f | head -1)
        echo "SDKMANAGER=$SDKMANAGER" >> $GITHUB_ENV
        SDK_DIR=$(dirname "$SDKMANAGER")
        echo "$SDK_DIR" >> $GITHUB_PATH
        
        # å®‰è£… Android ç»„ä»¶
        yes | "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools" "platforms;android-30" "build-tools;30.0.3"
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and platform
      run: |
        # ä½¿ç”¨ Cordova 11
        npm install -g cordova@11.0.0
        
        # æ¸…ç†
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°
        cordova platform add android@10.1.1
        
    - name: Install compatible Gradle
      run: |
        echo "ğŸ“¦ å®‰è£…å…¼å®¹çš„ Gradle ç‰ˆæœ¬..."
        
        # ç§»é™¤ç³»ç»Ÿ Gradle
        sudo rm -f /usr/bin/gradle
        sudo rm -rf /usr/share/gradle*
        
        # ä¸‹è½½ Gradle 7.5ï¼ˆä¸ Java 11 å’Œ Cordova Android 10 å…¼å®¹ï¼‰
        wget -q https://services.gradle.org/distributions/gradle-7.5-bin.zip
        unzip -q gradle-7.5-bin.zip
        sudo mv gradle-7.5 /opt/gradle
        sudo ln -s /opt/gradle/bin/gradle /usr/bin/gradle
        
        echo "âœ… å®‰è£… Gradle 7.5 å®Œæˆ"
        gradle --version
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        cordova build android --release
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk