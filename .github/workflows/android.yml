name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      run: |
        # ä¸‹è½½å…¼å®¹ Java 8 çš„å‘½ä»¤è¡Œå·¥å…·
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8092744_latest.zip
        
        mkdir -p android-sdk
        unzip -q commandlinetools-linux-8092744_latest.zip -d android-sdk/
        
        # æŸ¥æ‰¾ sdkmanager
        SDKMANAGER_PATH=$(find android-sdk -name "sdkmanager" -type f | head -1)
        echo "SDKMANAGER_PATH=$SDKMANAGER_PATH" >> $GITHUB_ENV
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        SDKMANAGER_DIR=$(dirname "$SDKMANAGER_PATH")
        echo "$SDKMANAGER_DIR" >> $GITHUB_PATH
        
    - name: Install Android components
      run: |
        # æŽ¥å—è®¸å¯è¯
        yes | sdkmanager --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        
        # å®‰è£… Android ç»„ä»¶
        sdkmanager --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools"
        sdkmanager --sdk_root=$GITHUB_WORKSPACE/android-sdk "platforms;android-29"
        sdkmanager --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;29.0.3"
        
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - uses: actions/setup-node@v4
      with:
        node-version: '16'
        
    - name: Install Cordova and Android platform
      run: |
        # ä½¿ç”¨ Cordova 10
        npm install -g cordova@10.0.0
        
        # æ¸…ç†æ—§å¹³å°
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°
        cordova platform add android@9.1.0
        
        echo "âœ… Android å¹³å°æ·»åŠ å®Œæˆ"
        
    - name: Setup Gradle wrapper
      run: |
        echo "ðŸ”§ è®¾ç½® Gradle wrapper..."
        
        if [ -d "platforms/android" ]; then
          cd platforms/android
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p gradle/wrapper
          
          # åˆ›å»º Gradle wrapper é…ç½®
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          echo "âœ… Gradle wrapper é…ç½®å®Œæˆ"
          
          # éªŒè¯é…ç½®
          echo "Gradle wrapper é…ç½®å†…å®¹:"
          cat gradle/wrapper/gradle-wrapper.properties
        else
          echo "âŒ platforms/android ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Build Android APK
      run: |
        echo "ðŸ—ï¸ æž„å»º Android APK..."
        cordova build android --release
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk
        retention-days: 30