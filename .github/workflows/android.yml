name: Build Home Assistant Android App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - debug
        - release

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  CORDOVA_VERSION: '11.0.0'
  ANDROID_PLATFORM_VERSION: '10.1.2'
  ANDROID_API_LEVEL: '33'
  ANDROID_BUILD_TOOLS: '33.0.0'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4

    # æ­¥éª¤ 2: è®¾ç½® Java 17 ç¯å¢ƒ
    - name: Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    # æ­¥éª¤ 3: è®¾ç½® Android SDKï¼ˆä¿®å¤è·¯å¾„é—®é¢˜ï¼‰
    - name: Setup Android SDK
      run: |
        echo "ğŸ“± è®¾ç½® Android SDK ç¯å¢ƒ..."
        
        # ä¸‹è½½ Android å‘½ä»¤è¡Œå·¥å…·
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        
        # åˆ›å»ºç›®å½•å¹¶è§£å‹
        mkdir -p android-sdk
        unzip -q cmdline-tools.zip -d android-sdk/
        
        # æ£€æŸ¥è§£å‹åçš„ç›®å½•ç»“æ„
        echo "è§£å‹åçš„ç›®å½•ç»“æ„:"
        find android-sdk -type f -name "sdkmanager" | head -10
        
        # æŸ¥æ‰¾ sdkmanager çš„å®é™…ä½ç½®
        SDKMANAGER_PATH=$(find android-sdk -name "sdkmanager" -type f | head -1)
        echo "æ‰¾åˆ° sdkmanager: $SDKMANAGER_PATH"
        
        if [ -z "$SDKMANAGER_PATH" ]; then
          echo "âŒ æœªæ‰¾åˆ° sdkmanagerï¼Œæ˜¾ç¤ºå®Œæ•´ç›®å½•ç»“æ„:"
          find android-sdk -type f | sort
          exit 1
        fi
        
        # è®¾ç½®æ‰§è¡Œæƒé™
        chmod +x "$SDKMANAGER_PATH"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        # å°†åŒ…å« sdkmanager çš„ç›®å½•æ·»åŠ åˆ° PATH
        SDKMANAGER_DIR=$(dirname "$SDKMANAGER_PATH")
        echo "$SDKMANAGER_DIR" >> $GITHUB_PATH
        
        # ä¿å­˜ sdkmanager è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "SDKMANAGER_PATH=$SDKMANAGER_PATH" >> $GITHUB_ENV
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f cmdline-tools.zip
        
        echo "âœ… Android SDK è®¾ç½®å®Œæˆ"

    # æ­¥éª¤ 4: æ¥å— Android è®¸å¯è¯
    - name: Accept Android licenses
      run: |
        echo "ğŸ“ æ¥å— Android SDK è®¸å¯è¯..."
        echo "ä½¿ç”¨ sdkmanager: $SDKMANAGER_PATH"
        
        # ä½¿ç”¨æ‰¾åˆ°çš„ sdkmanager è·¯å¾„
        yes | "$SDKMANAGER_PATH" --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        echo "âœ… è®¸å¯è¯æ¥å—å®Œæˆ"

    # æ­¥éª¤ 5: å®‰è£… Android ç»„ä»¶
    - name: Install Android components
      run: |
        echo "ğŸ“¦ å®‰è£… Android ç»„ä»¶..."
        
        # å®‰è£…å¹³å°å·¥å…·
        "$SDKMANAGER_PATH" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools"
        echo "âœ… platform-tools å®‰è£…å®Œæˆ"
        
        # å®‰è£… Android å¹³å°
        "$SDKMANAGER_PATH" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platforms;android-${{ env.ANDROID_API_LEVEL }}"
        echo "âœ… Android ${{ env.ANDROID_API_LEVEL }} å¹³å°å®‰è£…å®Œæˆ"
        
        # å®‰è£…æ„å»ºå·¥å…·
        "$SDKMANAGER_PATH" --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;${{ env.ANDROID_BUILD_TOOLS }}"
        echo "âœ… æ„å»ºå·¥å…· ${{ env.ANDROID_BUILD_TOOLS }} å®‰è£…å®Œæˆ"
        
        # å°† platform-tools æ·»åŠ åˆ° PATH
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH

    # æ­¥éª¤ 6: è®¾ç½® Node.js ç¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # æ­¥éª¤ 7: å®‰è£… Cordova
    - name: Install Cordova
      run: |
        echo "ğŸ”§ å®‰è£… Cordova..."
        npm install -g cordova@${{ env.CORDOVA_VERSION }}
        echo "âœ… Cordova ç‰ˆæœ¬: $(cordova --version)"

    # æ­¥éª¤ 8: æ¸…ç†å’Œå‡†å¤‡å¹³å°
    - name: Clean and prepare platform
      run: |
        echo "ğŸ§¹ æ¸…ç†æ—§å¹³å°æ–‡ä»¶..."
        
        # ç§»é™¤æ—§å¹³å°å’Œæ’ä»¶
        cordova platform remove android --nosave || true
        rm -rf platforms/android plugins
        
        echo "âœ… æ¸…ç†å®Œæˆ"

    # æ­¥éª¤ 9: æ·»åŠ  Android å¹³å°
    - name: Add Android platform
      run: |
        echo "ğŸ“± æ·»åŠ  Android å¹³å°..."
        cordova platform add android@${{ env.ANDROID_PLATFORM_VERSION }}
        echo "âœ… Android å¹³å°æ·»åŠ å®Œæˆ"

    # æ­¥éª¤ 10: æ„å»º APK
    - name: Build APK
      run: |
        echo "ğŸ—ï¸ å¼€å§‹æ„å»º APK..."
        
        cordova build android --release
        
        echo "âœ… æ„å»ºå®Œæˆ"

    # æ­¥éª¤ 11: éªŒè¯æ„å»ºç»“æœ
    - name: Verify build
      run: |
        echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
        
        APK_PATH="platforms/android/app/build/outputs/apk/release"
        
        if [ -d "$APK_PATH" ]; then
          echo "ğŸ“ APK æ–‡ä»¶ä½ç½®: $APK_PATH"
          
          # æ˜¾ç¤º APK æ–‡ä»¶ä¿¡æ¯
          for apk in "$APK_PATH"/*.apk; do
            if [ -f "$apk" ]; then
              echo "ğŸ“¦ ç”Ÿæˆçš„ APK: $(basename "$apk")"
              echo "   ğŸ“ æ–‡ä»¶å¤§å°: $(du -h "$apk" | cut -f1)"
            fi
          done
        else
          echo "âŒ APK ç›®å½•ä¸å­˜åœ¨: $APK_PATH"
          exit 1
        fi

    # æ­¥éª¤ 12: ä¸Šä¼  APK åˆ¶å“
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk
        retention-days: 30