name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Java 17
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        
    - name: Setup Android SDK with correct build tools
      run: |
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip -d android-sdk/
        
        echo "ANDROID_SDK_ROOT=$GITHUB_WORKSPACE/android-sdk" >> $GITHUB_ENV
        
        SDKMANAGER=$(find android-sdk -name "sdkmanager" -type f | head -1)
        SDK_DIR=$(dirname "$SDKMANAGER")
        echo "$SDK_DIR" >> $GITHUB_PATH
        
        # æ¥å—è®¸å¯è¯
        yes | "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk --licenses
        
        # å®‰è£…å¹³å°å·¥å…·
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platform-tools"
        echo "âœ… platform-tools å®‰è£…å®Œæˆ"
        
        # å®‰è£… Android å¹³å°
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "platforms;android-33"
        echo "âœ… Android 33 å¹³å°å®‰è£…å®Œæˆ"
        
        # å®‰è£…å¤šä¸ªæ„å»ºå·¥å…·ç‰ˆæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;33.0.2"
        echo "âœ… æ„å»ºå·¥å…· 33.0.2 å®‰è£…å®Œæˆ"
        
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;33.0.0"
        echo "âœ… æ„å»ºå·¥å…· 33.0.0 å®‰è£…å®Œæˆ"
        
        "$SDKMANAGER" --sdk_root=$GITHUB_WORKSPACE/android-sdk "build-tools;31.0.0"
        echo "âœ… æ„å»ºå·¥å…· 31.0.0 å®‰è£…å®Œæˆ"
        
        # æ·»åŠ  platform-tools åˆ° PATH
        echo "$GITHUB_WORKSPACE/android-sdk/platform-tools" >> $GITHUB_PATH
        
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and platform
      run: |
        npm install -g cordova@latest
        
        # æ¸…ç†
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°
        cordova platform add android@latest
        
    - name: Set Android build tools version
      run: |
        echo "ğŸ”§ è®¾ç½® Android æ„å»ºå·¥å…·ç‰ˆæœ¬..."
        
        if [ -d "platforms/android" ]; then
          cd platforms/android
          
          # è®¾ç½®ä½¿ç”¨å¯ç”¨çš„æ„å»ºå·¥å…·ç‰ˆæœ¬
          if [ -d "$ANDROID_SDK_ROOT/build-tools/33.0.2" ]; then
            echo "ä½¿ç”¨æ„å»ºå·¥å…· 33.0.2"
          elif [ -d "$ANDROID_SDK_ROOT/build-tools/33.0.0" ]; then
            echo "ä½¿ç”¨æ„å»ºå·¥å…· 33.0.0"
          elif [ -d "$ANDROID_SDK_ROOT/build-tools/31.0.0" ]; then
            echo "ä½¿ç”¨æ„å»ºå·¥å…· 31.0.0"
          else
            echo "å¯ç”¨çš„æ„å»ºå·¥å…·:"
            ls -la "$ANDROID_SDK_ROOT/build-tools/" || echo "æœªæ‰¾åˆ°æ„å»ºå·¥å…·ç›®å½•"
          fi
        fi
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        cordova build android --release --verbose
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk