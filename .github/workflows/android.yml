name: Build Home Assistant App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Java 17
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk
        echo "JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $GITHUB_ENV
        
    - name: Setup Android SDK
      run: |
        # ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ SDK
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        
        # æ¥å—è®¸å¯è¯
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # å®‰è£… Android 34 ç›¸å…³ç»„ä»¶
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
        echo "âœ… Android SDK 34 ç»„ä»¶å®‰è£…å®Œæˆ"
        
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Cordova and platform
      run: |
        npm install -g cordova@latest
        
        # æ¸…ç†æ—§çš„å¹³å°å’Œæ’ä»¶
        rm -rf platforms/android plugins
        
        # æ·»åŠ  Android å¹³å°ï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼‰
        cordova platform add android@12.0.0
        
    - name: Build Android APK
      run: |
        echo "ğŸ—ï¸ æ„å»º Android APK..."
        # æ¸…ç†å¹¶æ„å»º
        cordova clean
        cordova build android --release -- --versionCode=1
        
    - uses: actions/upload-artifact@v4
      with:
        name: home-assistant-app
        path: platforms/android/app/build/outputs/apk/release/*.apk